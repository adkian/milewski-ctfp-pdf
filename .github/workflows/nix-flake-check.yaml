name: Check and build documents

on:
  pull_request:

jobs:
  dependencies:
    name: Build dependencies
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Set up Git repository
        uses: actions/checkout@v3

      - name: Create global variables
        id: version
        run: echo "::set-output name=version::$(git rev-parse --short HEAD)"

  determine-matrix:
    name: Figure out the packages we need to build
    runs-on: ubuntu-latest
    needs: [dependencies]

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Set up Git repository
        uses: actions/checkout@v3

      - name: Install the Nix package manager
        uses: cachix/install-nix-action@v18

      - id: set-matrix
        run: |
          echo "::set-output name=matrix::$(
            nix eval --json --impure \
              --expr 'builtins.attrNames (import ./.).packages.x86_64-linux'
          )"

  build:
    name: Build documents
    needs: determine-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        packages: ${{fromJson(needs.determine-matrix.outputs.matrix)}}

    steps:
      - name: Set up Git repository
        uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v18

      - name: Nix flake check
        run: nix flake check

      - name: Build ${{ matrix.packages }}.pdf
        run: nix build .#${{ matrix.packages }}